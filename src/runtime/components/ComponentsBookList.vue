<template>
  <div class="componentsbook-container">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –¥–µ—Ä–µ–≤–æ–º —Ñ–∞–π–ª–æ–≤ -->
    <aside class="sidebar">
      <h2>üìÑ MD Components</h2>
      <ul class="file-tree">
        <TreeItem
          v-for="(node, index) in fileTree"
          :key="index"
          :node="node"
          :depth="0"
          :selected-file="`${selectedFile}.stories.vue`"
          @file-selected="selectFile"
          @file-button-click="fileButtonClick"
        />
      </ul>
    </aside>

    <!-- Iframe –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    <main class="preview">
      <iframe
        v-if="selectedFile"
        :src="`/componentsbook/${selectedFile}`"
      />
      <p v-else>
        –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª
      </p>
    </main>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import TreeItem from './TreeItem.vue'

const fileTree = ref([])
const selectedFile = ref('')

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏ —Å—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ
onMounted(async () => {
  try {
    const res = await fetch('/__componentsbook_devtools_api__/api/files')
    const data = await res.json()
    if (Array.isArray(data.files)) {
      fileTree.value = buildFileTree(data.files)
    }
  }
  catch (error) {
    console.error('[componentsbook] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:', error)
  }
})

// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤
function buildFileTree(filePaths) {
  const tree = []
  const map = {}

  filePaths.forEach((filePath) => {
    const parts = filePath.split('/')
    let current = tree

    parts.forEach((part, index) => {
      if (!map[part]) {
        const isFile = index === parts.length - 1
        const node = {
          name: part.replace(/\.stories.vue$/, ''),
          fullPath: filePath,
          isFile,
          children: isFile ? null : [],
        }
        map[part] = node
        current.push(node)
      }
      current = map[part].children
    })
  })

  return tree
}

// –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ -> –∑–∞–≥—Ä—É–∂–∞–µ–º –≤ iframe
const selectFile = (file) => {
  selectedFile.value = file.replace(/\.stories.vue$/, '').replace(/\/index$/, '')
}

const fileButtonClick = (file) => {
  let route = file.replace(/\.stories.vue$/, '').replace(/\/index$/, '')
  // –£–±–∏—Ä–∞–µ–º 'index', –µ—Å–ª–∏ –µ—Å—Ç—å
  route = route.replace(/\/index$/, '')
  window.open('/componentsbook/' + route, '_blank')
}

if (import.meta.client) {
  const observer = new MutationObserver(() => {
    const devTools = document.getElementById('nuxt-devtools-container')
    if (devTools) {
      console.log('[componentsbook] –£–¥–∞–ª—è–µ–º Nuxt DevTools –∏–∑ DOM')
      devTools.remove()
      observer.disconnect() // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    }
  })

  observer.observe(document.body, { childList: true, subtree: true })
}
</script>

<style>
.componentsbook-container {
  display: flex;
  height: 100vh;
}

.sidebar {
  width: 250px;
  border-right: 1px solid #ccc;
  padding: 1rem;
  overflow-y: auto;
}

.preview {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

iframe {
  width: 100%;
  height: 100%;
  border: none;
}

.file-tree {
  list-style: none;
  padding-left: 0;
}
</style>
